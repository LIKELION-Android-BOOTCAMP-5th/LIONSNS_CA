#  데이터베이스 초기 설정 가이드

**버전**: 2.1.0  
**마지막 업데이트**: 2024-12-19  
**대상**: 최초 프로젝트 설정자

---

##  목차

1. [사전 준비사항](#1-사전-준비사항)
2. [Supabase 프로젝트 생성](#2-supabase-프로젝트-생성)
3. [데이터베이스 스키마 설정](#3-데이터베이스-스키마-설정)
4. [Storage 버킷 설정](#4-storage-버킷-설정)
5. [RLS 정책 확인](#5-rls-정책-확인)
6. [테스트 및 검증](#6-테스트-및-검증)
7. [문제 해결](#7-문제-해결)

---

## 1. 사전 준비사항

### 필요한 것
-  Supabase 계정 (무료 플랜으로도 가능)
-  이 가이드 문서
-  `schema.sql` 파일 (같은 폴더에 위치)

### 확인 사항
- [ ] Supabase 대시보드 접속 가능
- [ ] SQL Editor 사용 가능
- [ ] 프로젝트 생성 권한

---

## 2. Supabase 프로젝트 생성

### 2.1 프로젝트 생성
1. [Supabase 대시보드](https://app.supabase.com/) 접속
2. **"New Project"** 클릭
3. 프로젝트 정보 입력:
   - **Name**: 원하는 프로젝트 이름 (예: `lion-sns`)
   - **Database Password**: 강력한 비밀번호 설정 (기록해두세요!)
   - **Region**: 가장 가까운 지역 선택
4. **"Create new project"** 클릭
5. 프로젝트 생성 완료 대기 (약 1-2분)

### 2.2 프로젝트 설정 확인
프로젝트가 생성되면 다음 정보를 확인하세요:
- **Project URL**: `https://[프로젝트-id].supabase.co`
- **API Key (anon public)**: Settings → API → anon public key

이 정보는 Flutter 앱 설정에 필요합니다.

---

## 3. 데이터베이스 스키마 설정

### 3.1 스키마 파일 준비
1. `docs/개발/데이터베이스/schema.sql` 파일 열기
2. 전체 내용 확인

** 주의사항**:
- 이 스크립트는 **모든 기존 데이터를 삭제**하고 새로 생성합니다
- 프로덕션 환경에서는 사용하지 마세요!
- 최초 설정 시에만 사용합니다

### 3.2 SQL Editor에서 실행
1. Supabase 대시보드 → **SQL Editor** 클릭
2. **"New query"** 클릭
3. `schema.sql` 파일의 전체 내용을 복사하여 붙여넣기
4. **"Run"** 버튼 클릭 (또는 `Ctrl+Enter` / `Cmd+Enter`)
5. 실행 결과 확인:
   - 성공: "Success. No rows returned" 메시지
   - 오류: 오류 메시지 확인 후 [문제 해결](#7-문제-해결) 참조

### 3.3 생성된 테이블 확인
1. Supabase 대시보드 → **Table Editor** 클릭
2. 다음 테이블들이 생성되었는지 확인:
   -  `user_profiles` - 사용자 프로필
   -  `device_tokens` - 푸시 알림 토큰
   -  `posts` - 게시글
   -  `post_likes` - 게시글 좋아요
   -  `comments` - 댓글
   -  `follows` - 팔로우/팔로잉

### 3.4 테이블 구조 확인
각 테이블의 구조를 확인하려면:
1. **Table Editor** → 테이블 선택
2. **"View table"** 클릭
3. 컬럼 목록 확인

---

## 4. Storage 버킷 설정

### 4.1 게시글 이미지 버킷 생성

#### Step 1: 버킷 생성
1. Supabase 대시보드 → **Storage** 클릭
2. **"Create a new bucket"** 클릭
3. 버킷 정보 입력:
   - **Name**: `post-images` (정확히 이 이름)
   - **Public bucket**:  **체크** (공개 접근 필요)
4. **"Create bucket"** 클릭

#### Step 2: 버킷 설정
1. 생성된 `post-images` 버킷 클릭
2. **"Settings"** 탭 클릭
3. 설정 확인:
   - **File size limit**: 5MB (또는 원하는 크기)
   - **Allowed MIME types**: `image/jpeg, image/png, image/webp, image/gif`

#### Step 3: RLS 정책 설정
1. **SQL Editor** 열기
2. `설정/Storage/storage_policies.sql` 파일 내용 복사하여 실행
3. 성공 메시지 확인

### 4.2 프로필 이미지 버킷 생성 (선택사항)

#### Step 1: 버킷 생성
1. Supabase 대시보드 → **Storage** 클릭
2. **"Create a new bucket"** 클릭
3. 버킷 정보 입력:
   - **Name**: `profile-images` (정확히 이 이름)
   - **Public bucket**:  **체크** (공개 접근 필요)
4. **"Create bucket"** 클릭

#### Step 2: 버킷 설정
1. 생성된 `profile-images` 버킷 클릭
2. **"Settings"** 탭 클릭
3. 설정 확인:
   - **File size limit**: 2MB (또는 원하는 크기)
   - **Allowed MIME types**: `image/jpeg, image/png, image/webp`

#### Step 3: RLS 정책 설정
1. **SQL Editor** 열기
2. `설정/Storage/storage_policies_profile.sql` 파일 내용 복사하여 실행
3. 성공 메시지 확인

### 4.3 확인
- [ ] `post-images` 버킷 생성 완료
- [ ] `post-images` 버킷이 Public으로 설정됨
- [ ] `storage_policies.sql` 실행 완료
- [ ] `profile-images` 버킷 생성 완료 (선택사항)
- [ ] `profile-images` 버킷이 Public으로 설정됨 (선택사항)
- [ ] `storage_policies_profile.sql` 실행 완료 (선택사항)

---

## 5. RLS 정책 확인

### 5.1 RLS 활성화 확인
1. Supabase 대시보드 → **Table Editor** 클릭
2. 각 테이블 선택
3. **"Policies"** 탭 확인
4. RLS가 **Enabled** 상태인지 확인

### 5.2 정책 목록 확인
다음 정책들이 생성되어 있어야 합니다:

#### `posts` 테이블
-  "Anyone can view posts" - 모든 사용자가 게시글 조회 가능
-  "Authenticated users can create posts" - 인증된 사용자만 생성 가능
-  "Users can update own posts" - 본인 게시글만 수정 가능
-  "Users can delete own posts" - 본인 게시글만 삭제 가능

#### `comments` 테이블
-  "Anyone can view comments" - 모든 사용자가 댓글 조회 가능
-  "Authenticated users can create comments" - 인증된 사용자만 생성 가능
-  "Users can update own comments" - 본인 댓글만 수정 가능
-  "Users can delete own comments" - 본인 댓글만 삭제 가능

#### `post_likes` 테이블
-  "Anyone can view likes" - 모든 사용자가 좋아요 조회 가능
-  "Authenticated users can create likes" - 인증된 사용자만 생성 가능
-  "Users can delete own likes" - 본인 좋아요만 삭제 가능

#### `user_profiles` 테이블
-  "Anyone can view profiles" - 모든 사용자가 프로필 조회 가능
-  "Users can update own profile" - 본인 프로필만 수정 가능
-  "Users can insert own profile" - 본인 프로필만 생성 가능

#### `follows` 테이블
-  "Anyone can view follows" - 모든 사용자가 팔로우 관계 조회 가능
-  "Authenticated users can follow" - 인증된 사용자만 팔로우 가능
-  "Users can unfollow" - 본인이 팔로우한 관계만 취소 가능

#### `device_tokens` 테이블
-  "Users can view own tokens" - 본인 토큰만 조회 가능
-  "Users can manage own tokens" - 본인 토큰만 관리 가능

---

## 6. 테스트 및 검증

### 6.1 테이블 생성 확인
SQL Editor에서 다음 쿼리 실행:
```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;
```

다음 테이블들이 출력되어야 합니다:
- `comments`
- `device_tokens`
- `follows`
- `post_likes`
- `posts`
- `user_profiles`

### 6.2 외래키 관계 확인
SQL Editor에서 다음 쿼리 실행:
```sql
SELECT
  tc.table_name, 
  kcu.column_name, 
  ccu.table_name AS foreign_table_name,
  ccu.column_name AS foreign_column_name 
FROM 
  information_schema.table_constraints AS tc 
  JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
  JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
WHERE constraint_type = 'FOREIGN KEY' 
  AND tc.table_schema = 'public'
ORDER BY tc.table_name;
```

다음 외래키 관계가 출력되어야 합니다:
- `posts.user_id` → `user_profiles.id`
- `comments.user_id` → `user_profiles.id`
- `follows.follower_id` → `user_profiles.id`
- `follows.following_id` → `user_profiles.id`
- `post_likes.user_id` → `auth.users.id`
- `device_tokens.user_id` → `auth.users.id`

### 6.3 함수 생성 확인
SQL Editor에서 다음 쿼리 실행:
```sql
SELECT routine_name 
FROM information_schema.routines 
WHERE routine_schema = 'public' 
ORDER BY routine_name;
```

다음 함수들이 출력되어야 합니다:
- `notify_new_post`
- `update_updated_at_column`

### 6.4 인덱스 생성 확인
SQL Editor에서 다음 쿼리 실행:
```sql
SELECT indexname 
FROM pg_indexes 
WHERE schemaname = 'public' 
ORDER BY indexname;
```

다음 인덱스들이 출력되어야 합니다:
- `idx_comments_created_at`
- `idx_comments_post_id`
- `idx_comments_user_id`
- `idx_device_tokens_token`
- `idx_device_tokens_user_id`
- `idx_follows_follower_following`
- `idx_follows_follower_id`
- `idx_follows_following_id`
- `idx_post_likes_post_id`
- `idx_post_likes_post_user`
- `idx_post_likes_user_id`
- `idx_posts_created_at`
- `idx_posts_user_id`

### 6.5 Storage 버킷 확인
1. Supabase 대시보드 → **Storage** 클릭
2. 다음 버킷들이 생성되어 있는지 확인:
   -  `post-images` (Public)
   -  `profile-images` (Public, 선택사항)

---

## 7. 문제 해결

### 오류: "relation already exists"
**원인**: 테이블이 이미 존재하는 경우

**해결 방법**:
1. `schema.sql`의 DROP 문이 먼저 실행됩니다
2. 그래도 오류가 발생하면:
   - SQL Editor에서 해당 테이블을 수동으로 삭제:
     ```sql
     DROP TABLE IF EXISTS {테이블명} CASCADE;
     ```
   - `schema.sql` 다시 실행

### 오류: "policy already exists"
**원인**: 정책이 이미 존재하는 경우

**해결 방법**:
1. `schema.sql`의 DROP POLICY 문이 먼저 실행됩니다
2. 그래도 오류가 발생하면:
   - SQL Editor에서 해당 정책을 수동으로 삭제:
     ```sql
     DROP POLICY IF EXISTS "{정책명}" ON {테이블명};
     ```
   - `schema.sql` 다시 실행

### 오류: "bucket does not exist" 또는 "new row violates row-level security policy"
**원인**: Storage 버킷이 없거나 RLS 정책이 설정되지 않음

**해결 방법**:
1. Supabase 대시보드 → **Storage** 확인
2. `post-images` 버킷이 생성되어 있는지 확인
3. 버킷이 **Public**으로 설정되어 있는지 확인
4. `설정/Storage/storage_policies.sql` 실행
5. 자세한 내용은 `설정/Storage/초기_설정_가이드.md` 참조

### 오류: "foreign key constraint cannot be implemented - Key columns are of incompatible types"
**원인**: 기존 테이블의 컬럼 타입이 맞지 않음 (예: TEXT vs UUID)

**해결 방법**:
1. 이 오류는 최초 설정 시에는 발생하지 않습니다
2. 기존 데이터베이스를 업데이트하는 경우:
   - `schema.sql`을 사용하여 전체 재생성

### 오류: "permission denied" 또는 "must be owner"
**원인**: 권한 부족

**해결 방법**:
1. 프로젝트 소유자인지 확인
2. SQL Editor의 권한 확인
3. 필요시 Supabase 관리자에게 문의

### 테이블이 생성되지 않음
**해결 방법**:
1. SQL Editor에서 오류 메시지 확인
2. `schema.sql`을 단계별로 나누어 실행:
   - 먼저 DROP 문 실행
   - 그 다음 CREATE 문 실행
3. 각 단계마다 결과 확인

### Storage 업로드가 실패함
**원인**: 버킷이 없거나 RLS 정책이 잘못 설정됨

**해결 방법**:
1. Storage 버킷이 생성되어 있는지 확인
2. 버킷이 Public으로 설정되어 있는지 확인
3. `설정/Storage/storage_policies.sql` 실행 확인
4. 자세한 내용은 `설정/Storage/초기_설정_가이드.md` 참조

---

## 8. 다음 단계

데이터베이스 초기 설정이 완료되면:

1.  [Supabase 초기 설정 가이드](../설정/Supabase_초기_설정_가이드.md) - Flutter 앱 연동
2.  [Storage 초기 설정 가이드](../설정/Storage/초기_설정_가이드.md) - Storage 상세 설정
3.  [소셜 로그인 완전 가이드](../설정/소셜_로그인_완전_가이드.md) - 소셜 로그인 설정
4.  [푸시 알림 완전 가이드](../설정/푸시_알림_완전_가이드.md) - 푸시 알림 설정 (선택사항)

---

## 9. 참고 자료

- [Supabase 공식 문서](https://supabase.com/docs)
- [PostgreSQL 공식 문서](https://www.postgresql.org/docs/)
- [Supabase Storage 가이드](https://supabase.com/docs/guides/storage)
- [RLS (Row Level Security) 가이드](https://supabase.com/docs/guides/auth/row-level-security)

---

## 10. 변경 이력

### v2.1.0 (2024-12-19)
- 최초 설계 문서 형태로 재구성
- 단계별 설명 강화
- 문제 해결 섹션 추가

### v2.0.0 (2024-11-05)
- user_profiles 외래키 관계 추가
- JOIN 쿼리 최적화 반영

### v1.0.0 (2024-10-27)
- 초기 가이드 작성

