#  Storage 초기 설정 가이드

**대상**: 최초 프로젝트 설정자

---

##  목차

1. [사전 준비사항](#1-사전-준비사항)
2. [Storage 버킷 생성](#2-storage-버킷-생성)
3. [RLS 정책 설정](#3-rls-정책-설정)
4. [프로필 이미지 버킷 설정 (선택사항)](#4-프로필-이미지-버킷-설정-선택사항)
5. [테스트 및 검증](#5-테스트-및-검증)
6. [문제 해결](#6-문제-해결)

---

## 1. 사전 준비사항

### 필요한 것
-  Supabase 프로젝트 생성 완료
-  데이터베이스 스키마 설정 완료
-  이 가이드 문서
-  Storage 정책 SQL 파일 (`storage_policies.sql`, `storage_policies_profile.sql`)

### 확인 사항
- [ ] Supabase 대시보드 접속 가능
- [ ] Storage 메뉴 접근 가능
- [ ] SQL Editor 사용 가능

** 참고**: Supabase 프로젝트 생성은 `설정/Supabase_초기_설정_가이드.md` 참조

---

## 2. Storage 버킷 생성

### 2.1 게시글 이미지 버킷 생성

#### Step 1: Storage 페이지 접속
1. Supabase 대시보드 접속
2. 프로젝트 선택
3. 좌측 메뉴에서 **Storage** 클릭

#### Step 2: 버킷 생성
1. **"Create a new bucket"** 버튼 클릭
2. 다음 정보 입력:
   - **Name**: `post-images` (정확히 이 이름으로 입력, 대소문자 구분)
   - **Public bucket**:  **체크** (반드시 활성화)
   - **File size limit**: `5242880` (5MB) 또는 원하는 크기
   - **Allowed MIME types**: `image/jpeg, image/png, image/webp, image/gif` (선택사항)
3. **"Create bucket"** 버튼 클릭

#### Step 3: 버킷 확인
1. Storage → **Buckets**에서 `post-images` 버킷 확인
2. 버킷 이름이 정확히 `post-images`인지 확인
3. **Public** 열에서 **Public**으로 표시되는지 확인

** 중요**: 
- 버킷 이름은 정확히 `post-images`로 입력해야 합니다
- **Public bucket**은 반드시 활성화해야 합니다 (공개 접근 필요)

---

## 3. RLS 정책 설정

### 3.1 SQL Editor 접속
1. Supabase 대시보드 → **SQL Editor** 클릭
2. **"New query"** 클릭

### 3.2 Storage 정책 SQL 실행
1. `docs/설정/storage_policies.sql` 파일 열기
2. 전체 내용 복사
3. SQL Editor에 붙여넣기
4. **"Run"** 버튼 클릭 (또는 `Ctrl+Enter` / `Cmd+Enter`)
5. 성공 메시지 확인: "Success. No rows returned"

### 3.3 생성된 정책 확인
Storage 정책이 다음과 같이 생성되었는지 확인:

1. **Anyone can view post images** - 모든 사용자가 이미지 조회 가능
2. **Authenticated users can upload post images** - 인증된 사용자가 이미지 업로드 가능
3. **Users can update own post images** - 작성자만 자신의 이미지 수정 가능
4. **Users can delete own post images** - 작성자만 자신의 이미지 삭제 가능

**확인 방법**:
1. Supabase 대시보드 → **Storage** → **Policies** 클릭
2. `post-images` 버킷의 정책 목록 확인

### 3.4 정책 설명

#### 모든 사용자 이미지 조회 가능
```sql
CREATE POLICY "Anyone can view post images"
  ON storage.objects
  FOR SELECT
  USING (bucket_id = 'post-images');
```
- **목적**: 게시글 이미지를 누구나 볼 수 있도록 설정
- **이유**: Public bucket이지만 명시적으로 정책 설정 권장

#### 인증된 사용자 이미지 업로드 가능
```sql
CREATE POLICY "Authenticated users can upload post images"
  ON storage.objects
  FOR INSERT
  WITH CHECK (
    bucket_id = 'post-images' AND
    auth.role() = 'authenticated'
  );
```
- **목적**: 로그인한 사용자만 이미지 업로드 가능
- **이유**: 비인증 사용자의 업로드 방지

#### 작성자만 이미지 수정 가능
```sql
CREATE POLICY "Users can update own post images"
  ON storage.objects
  FOR UPDATE
  USING (
    bucket_id = 'post-images' AND
    auth.role() = 'authenticated' AND
    auth.uid()::text = (string_to_array(name, '/'))[1]
  );
```
- **목적**: 작성자만 자신이 업로드한 이미지 수정 가능
- **파일 경로 형식**: `userId/postId/timestamp.extension`
- **동작**: 파일 경로의 첫 번째 부분 (userId)이 현재 사용자 ID와 일치하는지 확인

#### 작성자만 이미지 삭제 가능
```sql
CREATE POLICY "Users can delete own post images"
  ON storage.objects
  FOR DELETE
  USING (
    bucket_id = 'post-images' AND
    auth.role() = 'authenticated' AND
    auth.uid()::text = (string_to_array(name, '/'))[1]
  );
```
- **목적**: 작성자만 자신이 업로드한 이미지 삭제 가능
- **파일 경로 형식**: `userId/postId/timestamp.extension`
- **동작**: 파일 경로의 첫 번째 부분 (userId)이 현재 사용자 ID와 일치하는지 확인

---

## 4. 프로필 이미지 버킷 설정 (선택사항)

프로필 이미지를 별도 버킷에 저장하려면 다음 단계를 따르세요.

### 4.1 프로필 이미지 버킷 생성

#### Step 1: 버킷 생성
1. Supabase 대시보드 → **Storage** → **Buckets** 클릭
2. **"Create a new bucket"** 버튼 클릭
3. 다음 정보 입력:
   - **Name**: `profile-images` (정확히 이 이름으로 입력)
   - **Public bucket**:  **체크** (반드시 활성화)
   - **File size limit**: `2097152` (2MB) 또는 원하는 크기
   - **Allowed MIME types**: `image/jpeg, image/png, image/webp` (선택사항)
4. **"Create bucket"** 버튼 클릭

#### Step 2: 버킷 확인
1. Storage → **Buckets**에서 `profile-images` 버킷 확인
2. 버킷 이름이 정확히 `profile-images`인지 확인
3. **Public** 열에서 **Public**으로 표시되는지 확인

### 4.2 프로필 이미지 정책 설정

#### Step 1: SQL Editor 접속
1. Supabase 대시보드 → **SQL Editor** 클릭
2. **"New query"** 클릭

#### Step 2: Storage 정책 SQL 실행
1. `docs/설정/storage_policies_profile.sql` 파일 열기
2. 전체 내용 복사
3. SQL Editor에 붙여넣기
4. **"Run"** 버튼 클릭
5. 성공 메시지 확인

### 4.3 생성된 정책 확인
프로필 이미지 정책이 다음과 같이 생성되었는지 확인:

1. **Anyone can view profile images** - 모든 사용자가 프로필 이미지 조회 가능
2. **Users can upload own profile image** - 사용자가 자신의 프로필 이미지 업로드 가능
3. **Users can update own profile image** - 사용자가 자신의 프로필 이미지 수정 가능
4. **Users can delete own profile image** - 사용자가 자신의 프로필 이미지 삭제 가능

**확인 방법**:
1. Supabase 대시보드 → **Storage** → **Policies** 클릭
2. `profile-images` 버킷의 정책 목록 확인

---

## 5. 테스트 및 검증

### 5.1 버킷 생성 확인

SQL Editor에서 다음 쿼리 실행:
```sql
SELECT name, public 
FROM storage.buckets 
WHERE name IN ('post-images', 'profile-images');
```

다음 결과가 출력되어야 합니다:
- `post-images` - `public: true`
- `profile-images` - `public: true` (생성한 경우)

### 5.2 정책 생성 확인

SQL Editor에서 다음 쿼리 실행:
```sql
SELECT policyname, bucket_id
FROM pg_policies
WHERE schemaname = 'storage'
ORDER BY bucket_id, policyname;
```

다음 정책들이 출력되어야 합니다:

#### `post-images` 버킷:
- "Anyone can view post images"
- "Authenticated users can upload post images"
- "Users can update own post images"
- "Users can delete own post images"

#### `profile-images` 버킷 (생성한 경우):
- "Anyone can view profile images"
- "Users can upload own profile image"
- "Users can update own profile image"
- "Users can delete own profile image"

### 5.3 앱에서 테스트

#### Step 1: 앱 실행
```bash
flutter run
```

#### Step 2: 이미지 업로드 테스트
1. 게시글 작성 화면에서 이미지 선택
2. 이미지 업로드 시도
3. 업로드 성공 확인

#### Step 3: 이미지 조회 테스트
1. 게시글 목록에서 이미지가 표시되는지 확인
2. 게시글 상세에서 이미지가 표시되는지 확인

---

## 6. 문제 해결

### 오류 1: "버킷이 존재하지 않습니다"
**원인**: Storage 버킷이 생성되지 않았거나 이름이 잘못됨

**해결 방법**:
1. Supabase 대시보드 → **Storage** → **Buckets** 확인
2. `post-images` 버킷이 생성되어 있는지 확인
3. 버킷 이름이 정확히 `post-images`인지 확인 (대소문자 구분)
4. 버킷이 없으면 [버킷 생성](#2-storage-버킷-생성) 단계 다시 수행

### 오류 2: "new row violates row-level security policy" (403 오류)
**원인**: RLS 정책이 설정되지 않았거나 잘못 설정됨

**해결 방법**:
1. Supabase 대시보드 → **Storage** → **Policies** 확인
2. `post-images` 버킷의 정책 목록 확인
3. 다음 정책들이 있는지 확인:
   - "Authenticated users can upload post images"
   - "Users can update own post images"
4. 정책이 없으면 [RLS 정책 설정](#3-rls-정책-설정) 단계 다시 수행
5. `storage_policies.sql` 파일 실행 확인

### 오류 3: "Unauthorized" (401 오류)
**원인**: 사용자가 로그인하지 않았거나 세션이 만료됨

**해결 방법**:
1. 앱에서 로그인 확인
2. Supabase 세션이 유효한지 확인
3. 로그아웃 후 다시 로그인 시도

### 오류 4: "File size limit exceeded"
**원인**: 업로드하려는 이미지 크기가 버킷의 파일 크기 제한을 초과함

**해결 방법**:
1. Supabase 대시보드 → **Storage** → **Buckets** → `post-images` 클릭
2. **Settings** 탭에서 **File size limit** 확인
3. 필요시 파일 크기 제한 증가
4. 또는 앱에서 이미지 압축 기능 추가

### 오류 5: "Invalid MIME type"
**원인**: 업로드하려는 파일의 MIME 타입이 허용되지 않음

**해결 방법**:
1. Supabase 대시보드 → **Storage** → **Buckets** → `post-images` 클릭
2. **Settings** 탭에서 **Allowed MIME types** 확인
3. 필요한 MIME 타입 추가 (예: `image/heic`, `image/heif`)
4. 또는 **Allowed MIME types**를 비워서 모든 이미지 타입 허용

### 오류 6: 이미지가 표시되지 않음
**원인**: 버킷이 Public으로 설정되지 않았거나 이미지 URL이 잘못됨

**해결 방법**:
1. Supabase 대시보드 → **Storage** → **Buckets** 확인
2. `post-images` 버킷이 **Public**으로 설정되어 있는지 확인
3. Public이 아니면 버킷 편집에서 **Public bucket** 활성화
4. 이미지 URL이 올바른지 확인 (Supabase Storage URL 형식)

---

## 7. 다음 단계

Storage 초기 설정이 완료되면:

1.  [Supabase 초기 설정 가이드](../Supabase_초기_설정_가이드.md) - Flutter 앱 연동
2.  [소셜 로그인 완전 가이드](../소셜_로그인_완전_가이드.md) - 사용자 인증 설정
3.  [데이터베이스 초기 설정 가이드](../../개발/데이터베이스/초기_설정_가이드.md) - 데이터베이스 스키마 설정

---

## 8. 참고 자료

- [Supabase Storage 공식 문서](https://supabase.com/docs/guides/storage)
- [Supabase Storage RLS 정책 가이드](https://supabase.com/docs/guides/storage/security/access-control)
- [Supabase Storage API 참조](https://supabase.com/docs/reference/javascript/storage)

---

