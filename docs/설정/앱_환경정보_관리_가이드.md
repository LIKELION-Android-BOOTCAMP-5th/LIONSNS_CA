#  앱 환경정보 관리 가이드 (App Configuration Management)

**프로젝트명**: 커뮤니티 앱  
**작성일**: 2024-11-05  
**난이도**: 중급

---

##  목차

1. [개요](#1-개요)
2. [데이터베이스 설계](#2-데이터베이스-설계)
3. [백엔드 설정 (Supabase)](#3-백엔드-설정-supabase)
4. [프런트엔드 구현](#4-프런트엔드-구현)
5. [사용 방법](#5-사용-방법)

---

## 1. 개요

### 1.1 왜 필요한가?

앱에서 지원하는 기능(예: 소셜 로그인 Provider)을 **서버에서 제어**하고 싶을 때 유용합니다:

**예시:**
- Google 로그인:  지원
- Apple 로그인:  미지원 (일시적으로 비활성화)
- 카카오 로그인:  지원
- 네이버 로그인:  지원 (커스텀 OAuth provider)

**장점:**
- 앱 업데이트 없이 기능 활성화/비활성화 가능
- 환경별로 다른 설정 사용 (개발/스테이징/프로덕션)
- A/B 테스트나 점진적 롤아웃 가능
- 관리자 페이지에서 쉽게 설정 변경

### 1.2 구현 방식

1. **Supabase 테이블**에 앱 설정 정보 저장
2. **앱 초기화 시** 설정 정보 로드
3. **UI에서 동적으로** 버튼 표시/숨김 처리

---

## 2. 데이터베이스 설계

### 2.1 테이블 구조

```sql
CREATE TABLE IF NOT EXISTS app_config (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  key TEXT NOT NULL UNIQUE,  -- 설정 키 (예: 'auth_google_enabled')
  value TEXT NOT NULL,        -- 설정 값 (예: 'true', 'false', JSON 등)
  description TEXT,           -- 설정 설명
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 2.2 저장될 데이터 예시

| key | value | description |
|-----|-------|-------------|
| `auth_google_enabled` | `true` | Google 로그인 활성화 여부 |
| `auth_apple_enabled` | `false` | Apple 로그인 활성화 여부 |
| `auth_kakao_enabled` | `true` | 카카오 로그인 활성화 여부 |
| `auth_naver_enabled` | `false` | 네이버 로그인 활성화 여부 |
| `maintenance_mode` | `false` | 유지보수 모드 활성화 여부 |
| `app_version_min` | `1.0.0` | 최소 지원 앱 버전 |

---

## 3. 백엔드 설정 (Supabase)

### 3.1 테이블 생성

#### Step 1: SQL Editor 접속
1. Supabase 대시보드 > **SQL Editor** 클릭
2. "New query" 클릭

#### Step 2: 테이블 생성 쿼리 실행

```sql
-- app_config 테이블 생성
CREATE TABLE IF NOT EXISTS app_config (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  key TEXT NOT NULL UNIQUE,
  value TEXT NOT NULL,
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- updated_at 자동 업데이트 함수 (이미 있다면 생략)
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- updated_at 자동 업데이트 트리거
DROP TRIGGER IF EXISTS update_app_config_updated_at ON app_config;
CREATE TRIGGER update_app_config_updated_at
  BEFORE UPDATE ON app_config
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- RLS 활성화 (모든 사용자가 읽기 가능)
ALTER TABLE app_config ENABLE ROW LEVEL SECURITY;

-- 읽기 정책 (모든 인증된 사용자가 읽기 가능)
DROP POLICY IF EXISTS "Anyone can view app config" ON app_config;
CREATE POLICY "Anyone can view app config"
  ON app_config
  FOR SELECT
  USING (true);  -- 모든 사용자가 읽기 가능

-- 쓰기 정책 (관리자만 쓰기 가능 - 선택사항)
DROP POLICY IF EXISTS "Only admins can modify app config" ON app_config;
CREATE POLICY "Only admins can modify app config"
  ON app_config
  FOR ALL
  USING (
    -- 여기에 관리자 체크 로직 추가
    -- 예: auth.jwt() ->> 'user_role' = 'admin'
    false  -- 일단 비활성화 (수동으로만 수정)
  );
```

### 3.2 초기 데이터 삽입

#### Step 1: 초기 설정 데이터 삽입

```sql
-- 소셜 로그인 Provider 설정
INSERT INTO app_config (key, value, description) VALUES
  ('auth_google_enabled', 'true', 'Google 로그인 활성화 여부'),
  ('auth_apple_enabled', 'false', 'Apple 로그인 활성화 여부'),
  ('auth_kakao_enabled', 'true', '카카오 로그인 활성화 여부'),
  ('auth_naver_enabled', 'false', '네이버 로그인 활성화 여부'),
  ('maintenance_mode', 'false', '유지보수 모드 활성화 여부'),
  ('app_version_min', '1.0.0', '최소 지원 앱 버전')
ON CONFLICT (key) DO NOTHING;
```

#### Step 2: 데이터 확인

```sql
-- 모든 설정 조회
SELECT * FROM app_config ORDER BY key;
```

### 3.3 설정 변경 (관리자용)

나중에 설정을 변경하려면:

```sql
-- Google 로그인 비활성화
UPDATE app_config 
SET value = 'false', updated_at = NOW()
WHERE key = 'auth_google_enabled';

-- Apple 로그인 활성화
UPDATE app_config 
SET value = 'true', updated_at = NOW()
WHERE key = 'auth_apple_enabled';
```

**또는 Supabase 대시보드에서:**
1. **Table Editor** > **app_config** 선택
2. 해당 row 클릭하여 수정
3. **Save** 클릭

---

## 4. 프런트엔드 구현

### 4.1 Model 생성

#### 파일: `lib/core/models/app_config.dart`

```dart
import 'package:json_annotation/json_annotation.dart';

part 'app_config.g.dart';

/// 앱 설정 모델
@JsonSerializable()
class AppConfig {
  final String id;
  final String key;
  final String value;
  final String? description;
  final DateTime createdAt;
  final DateTime updatedAt;
  
  const AppConfig({
    required this.id,
    required this.key,
    required this.value,
    this.description,
    required this.createdAt,
    required this.updatedAt,
  });
  
  factory AppConfig.fromJson(Map<String, dynamic> json) => 
      _$AppConfigFromJson(json);
  Map<String, dynamic> toJson() => _$AppConfigToJson(this);
  
  /// Boolean 값으로 변환
  bool get boolValue => value.toLowerCase() == 'true';
  
  /// int 값으로 변환
  int? get intValue => int.tryParse(value);
  
  /// double 값으로 변환
  double? get doubleValue => double.tryParse(value);
}
```

#### JSON 코드 생성

```bash
flutter pub run build_runner build --delete-conflicting-outputs
```

### 4.2 Repository 구현

#### 파일: `lib/features/config/data/app_config_repository.dart`

```dart
import 'package:flutter/foundation.dart';
import '../../../core/models/app_config.dart';
import '../../../core/utils/result.dart';
import '../../../core/services/supabase_service.dart';

/// 앱 설정 Repository
class AppConfigRepository {
  static const String _tableName = 'app_config';
  
  /// 모든 설정 조회
  Future<Result<Map<String, AppConfig>>> getAllConfig() async {
    try {
      final response = await SupabaseService.client
          .from(_tableName)
          .select()
          .order('key');
      
      final configs = (response as List)
          .map((json) => AppConfig.fromJson(json as Map<String, dynamic>))
          .toList();
      
      // Map으로 변환 (key를 키로 사용)
      final configMap = {
        for (var config in configs) config.key: config
      };
      
      return Success(configMap);
    } catch (e) {
      debugPrint('설정 조회 오류: $e');
      return Failure('설정을 불러오는데 실패했습니다: $e');
    }
  }
  
  /// 특정 키의 설정 조회
  Future<Result<AppConfig?>> getConfig(String key) async {
    try {
      final response = await SupabaseService.client
          .from(_tableName)
          .select()
          .eq('key', key)
          .maybeSingle();
      
      if (response == null) {
        return const Success(null);
      }
      
      final config = AppConfig.fromJson(response as Map<String, dynamic>);
      return Success(config);
    } catch (e) {
      debugPrint('설정 조회 오류: $e');
      return Failure('설정을 불러오는데 실패했습니다: $e');
    }
  }
  
  /// Boolean 값 조회 (간편 메서드)
  Future<Result<bool>> getBool(String key, {bool defaultValue = false}) async {
    final result = await getConfig(key);
    return result.when(
      success: (config) {
        if (config == null) {
          return Success(defaultValue);
        }
        return Success(config.boolValue);
      },
      failure: (message, error) => Failure(message, error),
    );
  }
  
  /// String 값 조회 (간편 메서드)
  Future<Result<String>> getString(String key, {String defaultValue = ''}) async {
    final result = await getConfig(key);
    return result.when(
      success: (config) {
        if (config == null) {
          return Success(defaultValue);
        }
        return Success(config.value);
      },
      failure: (message, error) => Failure(message, error),
    );
  }
}
```

### 4.3 Provider 구현

#### 파일: `lib/features/config/viewmodel/app_config_provider.dart`

```dart
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../core/models/app_config.dart';
import '../../../core/utils/result.dart';
import '../data/app_config_repository.dart';

/// App Config Repository Provider
final appConfigRepositoryProvider = Provider<AppConfigRepository>((ref) {
  return AppConfigRepository();
});

/// 모든 설정을 Map으로 제공 (FutureProvider)
final appConfigMapProvider = FutureProvider<Result<Map<String, AppConfig>>>((ref) async {
  final repository = ref.watch(appConfigRepositoryProvider);
  return await repository.getAllConfig();
});

/// 특정 키의 설정 제공 (Family FutureProvider)
final appConfigProvider = FutureProvider.family<Result<AppConfig?>, String>((ref, key) async {
  final repository = ref.watch(appConfigRepositoryProvider);
  return await repository.getConfig(key);
});

/// Boolean 설정 제공 (Family FutureProvider)
final appConfigBoolProvider = FutureProvider.family<Result<bool>, String>((ref, key) async {
  final repository = ref.watch(appConfigRepositoryProvider);
  return await repository.getBool(key);
});

/// String 설정 제공 (Family FutureProvider)
final appConfigStringProvider = FutureProvider.family<Result<String>, String>((ref, key) async {
  final repository = ref.watch(appConfigRepositoryProvider);
  return await repository.getString(key);
});
```

### 4.4 로그인 화면에 적용

#### 파일: `lib/features/auth/ui/login_screen.dart` (수정)

```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../core/models/user.dart';
import '../../config/viewmodel/app_config_provider.dart';
import '../viewmodel/auth_provider.dart';

class LoginScreen extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // 각 소셜 로그인 Provider 활성화 여부 조회
    final googleEnabled = ref.watch(appConfigBoolProvider('auth_google_enabled'));
    final appleEnabled = ref.watch(appConfigBoolProvider('auth_apple_enabled'));
    final kakaoEnabled = ref.watch(appConfigBoolProvider('auth_kakao_enabled'));
    final naverEnabled = ref.watch(appConfigBoolProvider('auth_naver_enabled'));
    
    return Scaffold(
      body: Column(
        children: [
          // Google 로그인 버튼 (활성화된 경우만 표시)
          googleEnabled.when(
            data: (result) => result.when(
              success: (isEnabled) => isEnabled
                  ? _buildSnsButton(
                      context,
                      'Google로 로그인',
                      Icons.g_mobiledata,
                      Colors.red,
                      () => ref.read(authProvider.notifier).snsLogin(AuthProvider.google),
                    )
                  : const SizedBox.shrink(),
              failure: (_, __) => const SizedBox.shrink(),
            ),
            loading: () => const CircularProgressIndicator(),
            error: (_, __) => const SizedBox.shrink(),
          ),
          
          // Apple 로그인 버튼
          appleEnabled.when(
            data: (result) => result.when(
              success: (isEnabled) => isEnabled
                  ? _buildSnsButton(
                      context,
                      'Apple로 로그인',
                      Icons.apple,
                      Colors.black,
                      () => ref.read(authProvider.notifier).snsLogin(AuthProvider.apple),
                    )
                  : const SizedBox.shrink(),
              failure: (_, __) => const SizedBox.shrink(),
            ),
            loading: () => const SizedBox.shrink(),
            error: (_, __) => const SizedBox.shrink(),
          ),
          
          // 카카오 로그인 버튼
          kakaoEnabled.when(
            data: (result) => result.when(
              success: (isEnabled) => isEnabled
                  ? _buildSnsButton(
                      context,
                      '카카오로 로그인',
                      Icons.chat,
                      Colors.orange,
                      () => ref.read(authProvider.notifier).snsLogin(AuthProvider.kakao),
                    )
                  : const SizedBox.shrink(),
              failure: (_, __) => const SizedBox.shrink(),
            ),
            loading: () => const SizedBox.shrink(),
            error: (_, __) => const SizedBox.shrink(),
          ),
          
          // 네이버 로그인 버튼
          naverEnabled.when(
            data: (result) => result.when(
              success: (isEnabled) => isEnabled
                  ? _buildSnsButton(
                      context,
                      '네이버로 로그인',
                      Icons.public,
                      Colors.green,
                      () => ref.read(authProvider.notifier).snsLogin(AuthProvider.naver),
                    )
                  : const SizedBox.shrink(),
              failure: (_, __) => const SizedBox.shrink(),
            ),
            loading: () => const SizedBox.shrink(),
            error: (_, __) => const SizedBox.shrink(),
          ),
        ],
      ),
    );
  }
  
  Widget _buildSnsButton(
    BuildContext context,
    String text,
    IconData icon,
    Color color,
    VoidCallback onPressed,
  ) {
    return OutlinedButton.icon(
      onPressed: onPressed,
      icon: Icon(icon, color: color),
      label: Text(text),
    );
  }
}
```

### 4.5 더 간단한 방법 (Helper 함수 사용)

설정 로딩을 더 효율적으로 처리하려면:

#### 파일: `lib/features/config/utils/config_helper.dart`

```dart
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../viewmodel/app_config_provider.dart';

/// 설정 Helper
class ConfigHelper {
  /// 소셜 로그인 Provider 활성화 여부 확인
  static bool isSocialLoginEnabled(
    WidgetRef ref,
    String provider, {
    bool defaultValue = false,
  }) {
    final config = ref.watch(appConfigBoolProvider('auth_${provider}_enabled'));
    return config.when(
      data: (result) => result.when(
        success: (value) => value,
        failure: (_, __) => defaultValue,
      ),
      loading: () => defaultValue,
      error: (_, __) => defaultValue,
    );
  }
  
  /// 유지보수 모드 확인
  static bool isMaintenanceMode(WidgetRef ref) {
    final config = ref.watch(appConfigBoolProvider('maintenance_mode'));
    return config.when(
      data: (result) => result.when(
        success: (value) => value,
        failure: (_, __) => false,
      ),
      loading: () => false,
      error: (_, __) => false,
    );
  }
}
```

#### 사용 예시:

```dart
class LoginScreen extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // Helper 함수로 간단하게 확인
    final googleEnabled = ConfigHelper.isSocialLoginEnabled(ref, 'google');
    final appleEnabled = ConfigHelper.isSocialLoginEnabled(ref, 'apple');
    final kakaoEnabled = ConfigHelper.isSocialLoginEnabled(ref, 'kakao');
    final naverEnabled = ConfigHelper.isSocialLoginEnabled(ref, 'naver');
    
    return Scaffold(
      body: Column(
        children: [
          if (googleEnabled)
            _buildSnsButton(/* Google 버튼 */),
          if (appleEnabled)
            _buildSnsButton(/* Apple 버튼 */),
          if (kakaoEnabled)
            _buildSnsButton(/* 카카오 버튼 */),
          if (naverEnabled)
            _buildSnsButton(/* 네이버 버튼 */),
        ],
      ),
    );
  }
}
```

### 4.6 앱 초기화 시 설정 로드

#### 파일: `lib/main.dart` (수정)

```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'core/services/supabase_service.dart';
import 'features/config/viewmodel/app_config_provider.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // Supabase 초기화
  await SupabaseService.initialize();
  
  runApp(
    ProviderScope(
      child: MyApp(),
      // 앱 시작 시 설정 미리 로드 (선택사항)
      overrides: [
        // 설정을 미리 로드하여 캐싱
        appConfigMapProvider.overrideWith((ref) async {
          final repository = ref.watch(appConfigRepositoryProvider);
          return await repository.getAllConfig();
        }),
      ],
    ),
  );
}
```

---

## 5. 사용 방법

### 5.1 설정 변경

**Supabase 대시보드에서:**
1. **Table Editor** > **app_config** 선택
2. 변경할 설정 row 클릭
3. `value` 필드 수정
4. **Save** 클릭

**또는 SQL로:**
```sql
UPDATE app_config 
SET value = 'false' 
WHERE key = 'auth_google_enabled';
```

### 5.2 앱에서 확인

1. 앱 재시작 (또는 Hot Reload)
2. 로그인 화면에서 변경된 설정 확인
3. 비활성화된 Provider의 버튼은 표시되지 않음

### 5.3 추가 설정 예시

다른 설정도 추가할 수 있습니다:

```sql
-- 새 설정 추가
INSERT INTO app_config (key, value, description) VALUES
  ('feature_post_likes_enabled', 'true', '게시글 좋아요 기능 활성화'),
  ('feature_comments_enabled', 'true', '댓글 기능 활성화'),
  ('feature_sharing_enabled', 'false', '공유 기능 활성화'),
  ('max_post_length', '10000', '최대 게시글 길이'),
  ('max_image_upload_size', '5242880', '최대 이미지 업로드 크기 (bytes)')
ON CONFLICT (key) DO NOTHING;
```

---

## 6. 고급 활용

### 6.1 환경별 설정

개발/스테이징/프로덕션 환경별로 다른 설정 사용:

```sql
-- 환경별 설정 테이블
CREATE TABLE IF NOT EXISTS app_config_env (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  key TEXT NOT NULL,
  environment TEXT NOT NULL,  -- 'dev', 'staging', 'prod'
  value TEXT NOT NULL,
  UNIQUE(key, environment)
);

-- 프로덕션 환경 설정
INSERT INTO app_config_env (key, environment, value) VALUES
  ('auth_google_enabled', 'prod', 'true'),
  ('auth_apple_enabled', 'prod', 'true'),
  ('auth_kakao_enabled', 'prod', 'true');
```

### 6.2 캐싱 및 갱신

설정을 캐싱하고 주기적으로 갱신:

```dart
class AppConfigNotifier extends StateNotifier<Map<String, AppConfig>> {
  final AppConfigRepository repository;
  Timer? _refreshTimer;
  
  AppConfigNotifier(this.repository) : super({}) {
    loadConfig();
    // 5분마다 자동 갱신
    _refreshTimer = Timer.periodic(Duration(minutes: 5), (_) {
      loadConfig();
    });
  }
  
  Future<void> loadConfig() async {
    final result = await repository.getAllConfig();
    result.when(
      success: (config) => state = config,
      failure: (_, __) {},
    );
  }
  
  @override
  void dispose() {
    _refreshTimer?.cancel();
    super.dispose();
  }
}
```

---

## 7. 정리

이 가이드를 통해 다음을 구현했습니다:

 Supabase에 앱 설정 정보 저장  
 앱 초기화 시 설정 동적 로드  
 UI에 설정에 따른 동적 표시  
 서버에서 기능 활성화/비활성화 제어  

이제 앱 업데이트 없이도 서버에서 기능을 제어할 수 있습니다!

---

**작성자**: 커뮤니티 앱 개발팀  
**최종 업데이트**: 2024-11-05





