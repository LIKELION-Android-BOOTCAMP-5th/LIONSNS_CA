#  홈 화면 위젯 구현 가이드

**난이도**: 중급  
**소요 시간**: 설정 포함 약 2-3시간

---

##  목차

1. [개요](#1-개요)
2. [아키텍처](#2-아키텍처)
3. [Flutter 구현](#3-flutter-구현)
4. [Android 구현](#4-android-구현)
5. [iOS 구현](#5-ios-구현)
6. [Deep Link 처리](#6-deep-link-처리)
7. [사용 방법](#7-사용-방법)
8. [문제 해결](#8-문제-해결)
9. [참고 자료](#9-참고-자료)

---

## 1. 개요

### 1.1 위젯 기능

홈 화면 위젯을 통해 다음 정보를 표시합니다:

-  **총 게시글 개수**: 사용자가 작성한 모든 게시글 수
-  **총 좋아요 수**: 내 게시글에 받은 모든 좋아요 수
-  **총 댓글 수**: 내 게시글에 달린 모든 댓글 수
-  **최근 게시물**: 가장 최근에 작성한 게시물 정보 (제목, 미리보기)
-  **바로가기 기능**: 
  - 위젯 클릭 시 앱 실행
  - 최근 게시물 클릭 시 해당 게시물 상세 화면으로 이동
  - 비로그인 시 로그인 버튼 표시 및 로그인 화면 이동

### 1.2 플랫폼별 구현

- **Android**: Jetpack Compose Glance 1.1.1을 사용한 네이티브 위젯
- **iOS**: WidgetKit (SwiftUI)를 사용한 네이티브 위젯
- **Flutter**: 데이터 집계 및 네이티브 통신 (Method Channel)

---

## 2. 아키텍처

### 2.1 데이터 흐름

```
┌─────────────┐
│   Supabase  │
│  (Database) │
└──────┬──────┘
       │
       ▼
┌─────────────────┐
│ WidgetDataService│ ◄── 사용자 통계 집계
└──────┬──────────┘
       │
       ▼
┌──────────────────┐
│ SharedPreferences│ ◄── 데이터 저장 (Flutter)
│  (UserDefaults)  │ ◄── 데이터 저장 (iOS)
└──────┬───────────┘
       │
       ├─────────────────┬─────────────────┐
       ▼                 ▼                 ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   Android   │  │     iOS     │  │   Flutter   │
│   Widget    │  │   Widget    │  │     App     │
│  (Glance)   │  │ (WidgetKit) │  │             │
└─────────────┘  └─────────────┘  └─────────────┘
```

### 2.2 주요 컴포넌트

#### Flutter 측

1. **WidgetDataService** (`lib/core/services/internal/widget_data_service.dart`)
   - 사용자 통계 집계 (게시글, 좋아요, 댓글 수)
   - 최근 게시물 조회
   - SharedPreferences에 데이터 저장/읽기
   - `WidgetDataKeys`를 사용하여 키 관리

2. **WidgetUpdateService** (`lib/core/services/internal/widget_update_service.dart`)
   - Method Channel을 통한 네이티브 통신
   - 위젯 업데이트 요청
   - 데이터 저장 확인 및 재시도 로직

3. **WidgetUpdateServiceProvider** (`lib/core/services/internal/widget_update_service_provider.dart`)
   - Riverpod Provider로 서비스 제공

4. **DeepLinkService** (`lib/core/services/internal/deep_link_service.dart`)
   - Android 네이티브에서 받은 deep link를 Flutter 라우터로 전달
   - 위젯에서 게시글 상세 화면으로 이동 처리
   - 라우터 초기화 전 딥링크 큐잉

5. **WidgetDataKeys** (`lib/core/constants/widget_data_keys.dart`)
   - SharedPreferences 키 상수 정의
   - Android `WidgetDataKeys.kt`와 동기화 유지

#### Android 측

1. **HomeWidget.kt**: Jetpack Compose Glance 위젯 UI
   - 로그인 상태에 따른 UI 분기 (로그인 버튼 또는 통계 정보)
   - SharedPreferences에서 데이터 읽기

2. **HomeWidgetReceiver.kt**: 위젯 리시버 (업데이트 처리)

3. **MainActivity.kt**: 
   - Method Channel 처리 (`com.lionsns/widget`)
   - Deep Link 처리 (`com.lionsns/deep_link`)
   - `glance-action://` Intent 필터링

4. **WidgetDataKeys.kt**: SharedPreferences 키 상수 정의

#### iOS 측

1. **HomeWidget.swift**: WidgetKit Extension (SwiftUI)
2. **AppDelegate.swift**: Method Channel 처리

---

## 3. Flutter 구현

### 3.1 파일 구조

```
lib/
└── core/
    ├── constants/
    │   └── widget_data_keys.dart          # SharedPreferences 키 정의
    └── services/
        └── internal/
            ├── widget_data_service.dart        # 데이터 집계 및 저장
            ├── widget_update_service.dart      # Method Channel 통신
            ├── widget_update_service_provider.dart  # Provider
            └── deep_link_service.dart          # Deep Link 처리
```

### 3.2 WidgetDataKeys

SharedPreferences 키를 중앙 관리합니다.

```dart
class WidgetDataKeys {
  static const String userId = 'widget_data_userId';
  static const String totalPostsCount = 'widget_data_totalPostsCount';
  static const String totalLikesCount = 'widget_data_totalLikesCount';
  static const String totalCommentsCount = 'widget_data_totalCommentsCount';
  static const String recentPostId = 'widget_data_recentPostId';
  static const String recentPostTitle = 'widget_data_recentPostTitle';
  static const String recentPostPreview = 'widget_data_recentPostPreview';
  static const String recentPostCreatedAt = 'widget_data_recentPostCreatedAt';
  static const String updateTimestamp = 'widget_data_updateTimestamp';
}
```

**중요**: Flutter의 `shared_preferences`는 키 앞에 `flutter.` 프리픽스를 자동으로 추가합니다.  
Android 네이티브 코드에서는 `flutter.widget_data_xxx` 형태로 읽어야 합니다.

### 3.3 WidgetDataService

사용자 통계를 집계하고 SharedPreferences에 저장합니다.

**주요 메서드**:
- `updateWidgetData()`: Supabase에서 통계 조회 후 저장
- `loadWidgetData()`: SharedPreferences에서 데이터 읽기
- `clearWidgetData()`: 로그아웃 시 데이터 삭제

**데이터 모델**:
- `WidgetData`: 위젯 데이터 전체 구조
- `RecentPost`: 최근 게시물 정보

**특징**:
- `WidgetDataKeys`를 사용하여 키 관리
- 데이터 저장 후 확인 및 재시도 로직
- `updateTimestamp` 업데이트로 Glance 상태 변경 감지

### 3.4 WidgetUpdateService

Method Channel을 통해 네이티브 위젯에 업데이트를 요청합니다.

**Method Channel 이름**: `com.lionsns/widget`

**메서드**:
- `updateWidget()`: 위젯 데이터 업데이트 후 네이티브에 알림
- `clearWidget()`: 위젯 데이터 삭제 후 네이티브에 알림

**특징**:
- 데이터 저장 확인 후 네이티브 업데이트 요청
- 재시도 로직 포함

### 3.5 DeepLinkService

위젯에서 앱으로 이동할 때 deep link를 처리합니다.

**Method Channel 이름**: `com.lionsns/deep_link`

**주요 기능**:
- 위젯에서 게시글 상세 화면으로 이동
- 위젯에서 로그인 화면으로 이동
- 라우터 초기화 전 딥링크 큐잉
- 재시도 로직 포함

### 3.6 위젯 업데이트 트리거

위젯은 다음 시점에 자동으로 업데이트됩니다:

1. **앱 시작 시** (`MainNavigationScreen`)
2. **로그인/로그아웃 시** (`AuthViewModel`)
   - 로그인 성공 시
   - 로그아웃 시 (위젯 클리어)
   - 토큰 갱신 시
3. **게시글 작성/수정 시** (`PostFormScreen`)

---

## 4. Android 구현

### 4.1 Jetpack Compose Glance

Android 위젯은 **Jetpack Compose Glance 1.1.1**을 사용하여 구현되었습니다.

**버전**: `1.1.1`

**장점**:
- Compose 문법으로 UI 작성 가능
- Material 3 지원
- 타입 안전성
- `provideContent` 블록에서 직접 `dp`, `sp` 사용 가능

### 4.2 파일 구조

```
android/app/src/main/
├── kotlin/com/example/communityapp/
│   ├── MainActivity.kt                    # Method Channel 및 Deep Link 처리
│   └── widget/
│       ├── HomeWidget.kt                  # 위젯 UI (Glance)
│       ├── HomeWidgetReceiver.kt          # 위젯 리시버
│       └── WidgetDataKeys.kt              # 데이터 키 정의
├── res/
│   ├── xml/
│   │   └── home_widget_info.xml          # 위젯 설정
│   ├── layout/
│   │   ├── home_widget_initial.xml       # 초기 레이아웃
│   │   └── home_widget_preview.xml       # 위젯 프리뷰
│   ├── drawable/
│   │   └── widget_preview.xml            # 위젯 프리뷰 이미지
│   └── values/
│       ├── colors.xml                     # 위젯 색상 정의
│       └── strings.xml                    # 위젯 설명
└── AndroidManifest.xml                    # 위젯 리시버 및 Deep Link 등록
```

### 4.3 의존성 추가

`android/app/build.gradle.kts`:

```kotlin
plugins {
    id("org.jetbrains.kotlin.plugin.compose")  // Compose 플러그인 추가
}

dependencies {
    // Jetpack Compose for Widgets (Glance) - 1.1.1 버전
    implementation("androidx.glance:glance:1.1.1")
    implementation("androidx.glance:glance-appwidget:1.1.1")
    implementation("androidx.glance:glance-material3:1.1.1")
    
    // WorkManager for background updates
    implementation("androidx.work:work-runtime-ktx:2.9.0")
    
    // Kotlin Coroutines
    implementation("org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.3")
    
    // DataStore Preferences
    implementation("androidx.datastore:datastore-preferences:1.1.1")
}
```

`android/settings.gradle.kts`:

```kotlin
plugins {
    id("org.jetbrains.kotlin.plugin.compose")  // Compose 플러그인 추가
}
```

### 4.4 MainActivity 설정

**Method Channel**: `com.lionsns/widget`  
**Deep Link Channel**: `com.lionsns/deep_link`

**주요 기능**:
1. `glance-action://` Intent의 data 제거 (라우터가 `/CALLBACK` 경로로 이동하지 않도록)
2. 위젯 업데이트 요청 처리
3. Deep Link 처리 (`postId`, `deepLinkPath` extra 확인)

**Launch Mode**: `singleTask` (AndroidManifest.xml)

### 4.5 위젯 구현

**HomeWidget.kt**에서는 SharedPreferences에서 직접 데이터를 읽어 UI를 구성합니다.

**주요 특징**:
- 로그인 상태에 따른 UI 분기
  - 비로그인: "로그인이 필요합니다" 메시지 + 로그인 버튼
  - 로그인: 통계 정보 + 최근 게시물
- `WidgetDataKeys`를 사용하여 키 관리
- `ColorProvider`를 사용하여 `colors.xml`의 색상 참조

### 4.6 WidgetDataKeys

SharedPreferences 키를 중앙 관리합니다.

```kotlin
object WidgetDataKeys {
    const val USER_ID = "flutter.widget_data_userId"
    const val TOTAL_POSTS = "flutter.widget_data_totalPostsCount"
    const val TOTAL_LIKES = "flutter.widget_data_totalLikesCount"
    const val TOTAL_COMMENTS = "flutter.widget_data_totalCommentsCount"
    const val RECENT_POST_ID = "flutter.widget_data_recentPostId"
    const val RECENT_POST_TITLE = "flutter.widget_data_recentPostTitle"
    const val RECENT_POST_PREVIEW = "flutter.widget_data_recentPostPreview"
    const val RECENT_POST_CREATED_AT = "flutter.widget_data_recentPostCreatedAt"
    const val UPDATE_TIMESTAMP = "flutter.widget_data_updateTimestamp"
}
```

### 4.7 AndroidManifest 설정

**위젯 리시버 등록**:

```xml
<receiver
    android:name=".widget.HomeWidgetReceiver"
    android:exported="true">
    <intent-filter>
        <action android:name="android.appwidget.action.APPWIDGET_UPDATE" />
    </intent-filter>
    <meta-data
        android:name="android.appwidget.provider"
        android:resource="@xml/home_widget_info" />
</receiver>
```

**Deep Link 처리**:

```xml
<intent-filter>
    <action android:name="android.intent.action.VIEW" />
    <category android:name="android.intent.category.DEFAULT" />
    <category android:name="android.intent.category.BROWSABLE" />
    <data android:scheme="lionsns" />
</intent-filter>
```

**Launch Mode**:

```xml
<activity
    android:name=".MainActivity"
    android:launchMode="singleTask"
    ...>
</activity>
```

---

## 5. iOS 구현

### 5.1 WidgetKit

iOS 위젯은 **WidgetKit**을 사용하여 SwiftUI로 구현되었습니다.

### 5.2 파일 구조

```
ios/
├── Runner/
│   └── AppDelegate.swift                  # Method Channel 처리
└── HomeWidget/
    └── HomeWidget.swift                   # WidgetKit Extension
```

### 5.3 AppDelegate 설정

Method Channel을 설정합니다:

```swift
let widgetChannel = FlutterMethodChannel(
  name: "com.lionsns/widget",
  binaryMessenger: controller.binaryMessenger
)

widgetChannel.setMethodCallHandler { (call, result) in
  switch call.method {
  case "updateWidget":
    WidgetCenter.shared.reloadTimelines(ofKind: "HomeWidget")
    result(true)
  // ...
  }
}
```

### 5.4 위젯 구현

**HomeWidget.swift**에서는 UserDefaults (App Groups 사용)에서 데이터를 읽습니다.

### 5.5  추가 작업 필요

iOS 위젯을 완전히 작동시키려면 다음 작업이 필요합니다:

1. **Xcode에서 Widget Extension 타겟 추가**
2. **App Groups 설정** (Runner + Widget Extension)
3. **Info.plist 수정**

---

## 6. Deep Link 처리

### 6.1 위젯에서 앱으로 이동

위젯에서 앱으로 이동할 때 다음과 같이 처리됩니다:

1. **위젯 클릭** → 앱 실행 (홈 화면)
2. **로그인 버튼 클릭** → 로그인 화면
3. **최근 게시물 클릭** → 게시글 상세 화면

### 6.2 Deep Link 흐름

```
┌─────────────┐
│   위젯      │
│  (Glance)   │
└──────┬──────┘
       │ Intent (postId 또는 deepLinkPath extra)
       ▼
┌─────────────┐
│ MainActivity│
└──────┬──────┘
       │ Method Channel
       ▼
┌─────────────┐
│DeepLinkService│
└──────┬──────┘
       │ GoRouter
       ▼
┌─────────────┐
│  Flutter    │
│   Router    │
└─────────────┘
```

### 6.3 MainActivity Deep Link 처리

1. `glance-action://` Intent의 data를 제거 (`setData(null)`)
2. Intent extra에서 `postId` 또는 `deepLinkPath` 확인
3. Method Channel을 통해 Flutter에 전달

### 6.4 DeepLinkService 처리

1. 라우터 초기화 전 딥링크 큐잉
2. 게시글 상세로 이동 시 홈 화면을 먼저 스택에 추가 (백키 처리)
3. 재시도 로직 포함

---

## 7. 사용 방법

### 7.1 위젯 추가하기

#### Android

1. 홈 화면에서 빈 공간을 길게 누름
2. "위젯" 선택
3. "Lion SNS" 또는 "lionsns" 검색
4. 위젯을 홈 화면에 드래그

#### iOS

1. 홈 화면에서 빈 공간을 길게 누름
2. 좌측 상단 "+" 버튼 탭
3. "Lion SNS" 검색
4. 원하는 크기 선택 후 "위젯 추가"

### 7.2 위젯 업데이트

위젯은 다음 시점에 자동으로 업데이트됩니다:

- 앱 실행 시
- 로그인/로그아웃 시
- 게시글 작성/수정 시

### 7.3 위젯 상호작용

- **위젯 전체 클릭**: 앱 실행 (홈 화면)
- **로그인 버튼 클릭**: 로그인 화면으로 이동
- **최근 게시물 클릭**: 해당 게시물 상세 화면으로 이동

---

## 8. 문제 해결

### 8.1 Android 위젯이 표시되지 않음

**원인**: 위젯이 시스템에 등록되지 않음

**해결**:
1. `AndroidManifest.xml`에 위젯 리시버가 등록되어 있는지 확인
2. `home_widget_info.xml` 파일이 존재하는지 확인
3. 앱을 완전히 삭제 후 다시 설치

### 8.2 위젯 데이터가 업데이트되지 않음

**원인**: SharedPreferences 키 불일치 또는 데이터 저장 실패

**해결**:
1. `WidgetDataKeys`와 Android `WidgetDataKeys.kt`의 키가 일치하는지 확인
2. Flutter에서 데이터 저장 확인
3. Android에서 SharedPreferences 키 확인 (`flutter.widget_data_xxx` 형태)

### 8.3 위젯 클릭 시 앱이 실행되지 않음

**원인**: Deep Link 설정 누락

**해결**:
1. `AndroidManifest.xml`에 Deep Link intent-filter가 등록되어 있는지 확인
2. `MainActivity`의 `launchMode`가 `singleTask`인지 확인

### 8.4 위젯에서 게시글 상세로 이동하지 않음

**원인**: Deep Link 처리 실패

**해결**:
1. `MainActivity`에서 `postId` extra가 전달되는지 확인
2. `DeepLinkService`가 제대로 초기화되었는지 확인
3. 라우터가 준비될 때까지 딥링크가 큐잉되는지 확인

### 8.5 위젯에 로그인 버튼이 계속 표시됨

**원인**: `userId`가 SharedPreferences에 저장되지 않음

**해결**:
1. Flutter에서 로그인 후 `WidgetDataService.updateWidgetData()`가 호출되는지 확인
2. SharedPreferences에 `flutter.widget_data_userId` 키가 저장되는지 확인
3. 위젯 업데이트가 제대로 트리거되는지 확인

### 8.6 iOS 위젯이 작동하지 않음

**원인**: Widget Extension 타겟이 추가되지 않음

**해결**:
1. Xcode에서 Widget Extension 타겟 추가
2. App Groups 설정 확인
3. Widget Extension의 Bundle Identifier 확인

---

## 9. 참고 자료

- [Jetpack Glance 공식 문서](https://developer.android.com/jetpack/androidx/releases/glance)
- [Compose for Widgets 가이드](https://developer.android.com/develop/ui/compose/glance)
- [WidgetKit 문서](https://developer.apple.com/documentation/widgetkit)
- [Flutter Method Channel 가이드](https://docs.flutter.dev/platform-integration/platform-channels)
- [Flutter Deep Link 가이드](https://docs.flutter.dev/development/ui/navigation/deep-linking)

---

