#  푸시 알림 완전 가이드

**버전**: 2.2.0  
**마지막 업데이트**: 2024-12-19  
**난이도**: 중급  
**소요 시간**: 약 3-4시간

---

##  목차

1. [사전 준비사항](#1-사전-준비사항)
2. [Firebase 설정](#2-firebase-설정)
3. [Supabase 설정](#3-supabase-설정)
4. [Flutter 설정](#4-flutter-설정)
5. [코드 구현](#5-코드-구현)
6. [채널별 푸시 알림](#6-채널별-푸시-알림)
7. [Edge Function 구현](#7-edge-function-구현)
8. [테스트 및 검증](#8-테스트-및-검증)
9. [문제 해결](#9-문제-해결)

---

## 1. 사전 준비사항

### 1.1 필요한 계정

다음 계정들이 필요합니다:

-  **Firebase 프로젝트** (https://console.firebase.google.com) - 무료 플랜
-  **Supabase 프로젝트** (이미 설정되어 있음)
-  **Apple Developer 계정** (iOS 푸시 알림용) - 유료 (연간 $99)
-  **Android Studio** 또는 **Xcode** (플랫폼별 설정용)

### 1.2 개발 환경

- Flutter SDK 3.x 이상
- Dart SDK 3.x 이상
- Android Studio / Xcode
- 실제 기기 (에뮬레이터/시뮬레이터에서는 푸시 알림 테스트 제한적)

### 1.3 확인 사항

- [ ] Supabase 프로젝트 생성 완료
- [ ] 데이터베이스 스키마 설정 완료 (`device_tokens` 테이블 포함)
- [ ] Firebase 계정 준비 완료

** 참고**: Supabase 프로젝트 생성은 `설정/Supabase_초기_설정_가이드.md` 참조

---

## 2. Firebase 설정

### 2.1 Firebase 프로젝트 생성

#### Step 1: 프로젝트 생성
1. [Firebase Console](https://console.firebase.google.com) 접속
2. **"프로젝트 추가"** 또는 **"Add project"** 클릭
3. 프로젝트 이름 입력 (예: `Community App`)
4. Google Analytics 설정 (선택사항)
5. **"프로젝트 만들기"** 클릭

#### Step 2: Android 앱 등록
1. Firebase 프로젝트 대시보드에서 **"Android 아이콘"** 클릭
2. 패키지 이름 입력 (예: `com.example.communityapp`)
3. 앱 닉네임 입력 (선택사항)
4. **"앱 등록"** 클릭
5. **`google-services.json`** 파일 다운로드
6. 파일을 `android/app/` 디렉토리에 복사

#### Step 3: iOS 앱 등록
1. Firebase 프로젝트 대시보드에서 **"iOS 아이콘"** 클릭
2. iOS 번들 ID 입력 (예: `com.example.communityapp`)
3. 앱 닉네임 입력 (선택사항)
4. **"앱 등록"** 클릭
5. **`GoogleService-Info.plist`** 파일 다운로드
6. Xcode에서 프로젝트 열어 파일 추가 (드래그 앤 드롭)

#### Step 4: Firebase Cloud Messaging 활성화
1. Firebase Console → **프로젝트 설정** → **클라우드 메시징** 탭
2. **"클라우드 메시징 API (V1)"** 활성화 확인
3. 필요시 Google Cloud Console에서 활성화:
   - https://console.cloud.google.com/apis/library/fcm.googleapis.com

---

## 3. Supabase 설정

### 3.1 데이터베이스 테이블 확인

`device_tokens` 테이블이 이미 생성되어 있는지 확인합니다. `개발/데이터베이스/schema.sql` 파일에 포함되어 있습니다.

**테이블 구조:**
```sql
CREATE TABLE IF NOT EXISTS device_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  device_token TEXT NOT NULL UNIQUE,
  device_type TEXT CHECK (device_type IN ('ios', 'android', 'web')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**RLS 정책:**
- 사용자는 자신의 토큰만 조회/수정/삭제 가능
- 서버는 모든 토큰 조회 가능 (Edge Function용)

### 3.2 테이블 생성 확인

1. Supabase 대시보드 → **Table Editor** 클릭
2. `device_tokens` 테이블이 생성되어 있는지 확인
3. 없으면 `개발/데이터베이스/schema.sql` 실행

---

## 4. Flutter 설정

### 4.1 패키지 설치

`pubspec.yaml`에 다음 패키지 추가:

```yaml
dependencies:
  firebase_core: ^3.6.0
  firebase_messaging: ^15.1.3
  flutter_local_notifications: ^18.0.1
```

패키지 설치:
```bash
flutter pub get
```

### 4.2 Android 설정

#### Step 1: build.gradle 파일 수정

`android/build.gradle`:
```gradle
buildscript {
    dependencies {
        classpath 'com.google.gms:google-services:4.4.0'
    }
}
```

`android/app/build.gradle`:
```gradle
plugins {
    id "com.android.application"
    id "kotlin-android"
    id "dev.flutter.flutter-gradle-plugin"
    id 'com.google.gms.google-services' // 추가
}
```

#### Step 2: AndroidManifest.xml 수정

`android/app/src/main/AndroidManifest.xml`:
```xml
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <application>
        <!-- 알림 채널 설정 -->
        <meta-data
            android:name="com.google.firebase.messaging.default_notification_channel_id"
            android:value="high_importance_channel" />
    </application>
</manifest>
```

### 4.3 iOS 설정

#### Step 1: Info.plist 수정

`ios/Runner/Info.plist`:
```xml
<key>FirebaseAppDelegateProxyEnabled</key>
<false/>
```

#### Step 2: Capabilities 추가

Xcode에서:
1. **Runner** 타겟 선택
2. **Signing & Capabilities** 탭
3. **+ Capability** 클릭
4. **Push Notifications** 추가
5. **Background Modes** 추가
   - **Remote notifications** 체크

#### Step 3: APNs 인증 키 설정 (iOS)

1. [Apple Developer Portal](https://developer.apple.com/account) 접속
2. **Certificates, Identifiers & Profiles** → **Keys** 클릭
3. **+** 버튼 클릭하여 새 키 생성
4. **Key Name**: `Firebase Push Notifications`
5. **Apple Push Notifications service (APNs)** 체크
6. **Continue** > **Register** 클릭
7. `.p8` 파일 다운로드 (한 번만 다운로드 가능!)
8. **Key ID** 복사

9. Firebase Console로 돌아가기:
   - **프로젝트 설정** → **클라우드 메시징** 탭
   - **APNs 인증 키** 섹션에서 `.p8` 파일 업로드
   - **키 ID** 입력
   - **팀 ID** 입력 (Apple Developer 계정의 Team ID)

---

## 5. 코드 구현

### 5.1 Firebase 초기화

#### 파일: `lib/main.dart`

```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_messaging/firebase_messaging.dart';
import 'core/services/external/supabase_service.dart';
import 'config/router.dart';

/// 백그라운드 메시지 핸들러 등록
@pragma('vm:entry-point')
Future<void> firebaseMessagingBackgroundHandler(RemoteMessage message) async {
  await Firebase.initializeApp();
  debugPrint(' 백그라운드 메시지: ${message.notification?.title}');
}

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // Firebase 초기화
  try {
    await Firebase.initializeApp();
    debugPrint(' Firebase 초기화 완료');
    
    // 백그라운드 메시지 핸들러 등록
    FirebaseMessaging.onBackgroundMessage(firebaseMessagingBackgroundHandler);
  } catch (e) {
    debugPrint(' Firebase 초기화 실패: $e');
    debugPrint(' Firebase 설정 파일을 확인하세요 (google-services.json, GoogleService-Info.plist)');
  }
  
  // Supabase 초기화
  try {
    await SupabaseService.initialize();
  } catch (e) {
    debugPrint(' Supabase 초기화 실패: $e');
  }
  
  runApp(
    const ProviderScope(
      child: MyApp(),
    ),
  );
}
```

### 5.2 Push Notification Service 생성

#### 파일: `lib/core/services/push_notification_service.dart`

```dart
import 'package:firebase_messaging/firebase_messaging.dart';
import 'package:flutter/foundation.dart';
import 'package:flutter_local_notifications/flutter_local_notifications.dart';
import 'dart:io' show Platform;
import '../external/supabase_service.dart';

class PushNotificationService {
  static final FirebaseMessaging _fcm = FirebaseMessaging.instance;
  static final FlutterLocalNotificationsPlugin _localNotifications =
      FlutterLocalNotificationsPlugin();
  
  /// 초기화
  static Future<void> initialize() async {
    try {
      // 알림 권한 요청
      NotificationSettings settings = await _fcm.requestPermission(
        alert: true,
        announcement: false,
        badge: true,
        carPlay: false,
        criticalAlert: false,
        provisional: false,
        sound: true,
      );
      
      if (settings.authorizationStatus == AuthorizationStatus.authorized) {
        debugPrint(' 알림 권한 승인됨');
      } else {
        debugPrint(' 알림 권한 거부됨');
        return;
      }
      
      // 로컬 알림 초기화
      await _initializeLocalNotifications();
      
      // FCM 토큰 가져오기 및 저장
      await _setupFCMToken();
      
      // 알림 핸들러 설정
      _setupMessageHandlers();
      
      debugPrint(' 푸시 알림 서비스 초기화 완료');
    } catch (e) {
      debugPrint(' 푸시 알림 초기화 실패: $e');
    }
  }
  
  /// 로컬 알림 초기화
  static Future<void> _initializeLocalNotifications() async {
    const AndroidInitializationSettings androidSettings =
        AndroidInitializationSettings('@mipmap/ic_launcher');
    
    const DarwinInitializationSettings iosSettings =
        DarwinInitializationSettings(
      requestAlertPermission: true,
      requestBadgePermission: true,
      requestSoundPermission: true,
    );
    
    const InitializationSettings initSettings = InitializationSettings(
      android: androidSettings,
      iOS: iosSettings,
    );
    
    await _localNotifications.initialize(initSettings);
    
    // Android 알림 채널 생성
    if (Platform.isAndroid) {
      const AndroidNotificationChannel channel = AndroidNotificationChannel(
        'high_importance_channel',
        'High Importance Notifications',
        description: 'This channel is used for important notifications.',
        importance: Importance.high,
      );
      
      await _localNotifications
          .resolvePlatformSpecificImplementation<
              AndroidFlutterLocalNotificationsPlugin>()
          ?.createNotificationChannel(channel);
    }
  }
  
  /// FCM 토큰 설정
  static Future<void> _setupFCMToken() async {
    try {
      String? token = await _fcm.getToken();
      if (token != null) {
        debugPrint(' FCM 토큰: $token');
        await saveTokenToSupabase(token);
      }
      
      // 토큰 갱신 리스너
      _fcm.onTokenRefresh.listen((newToken) {
        debugPrint(' FCM 토큰 갱신: $newToken');
        saveTokenToSupabase(newToken);
      });
    } catch (e) {
      debugPrint(' FCM 토큰 가져오기 실패: $e');
    }
  }
  
  /// FCM 토큰을 Supabase에 저장
  static Future<void> saveTokenToSupabase(String token) async {
    try {
      final userId = SupabaseService.currentUser?.id;
      if (userId == null) {
        debugPrint(' 로그인된 사용자가 없어 토큰을 저장할 수 없습니다');
        return;
      }
      
      // 플랫폼 감지
      String platform;
      if (kIsWeb) {
        platform = 'web';
      } else if (Platform.isIOS) {
        platform = 'ios';
      } else if (Platform.isAndroid) {
        platform = 'android';
      } else {
        platform = 'unknown';
      }
      
      // device_tokens 테이블에 토큰 저장
      await SupabaseService.client.from('device_tokens').upsert({
        'user_id': userId,
        'device_token': token,
        'device_type': platform,
        'updated_at': DateTime.now().toIso8601String(),
      }, onConflict: 'device_token');
      
      debugPrint(' FCM 토큰 저장 완료 (플랫폼: $platform)');
    } catch (e) {
      debugPrint(' FCM 토큰 저장 실패: $e');
    }
  }
  
  /// 알림 메시지 핸들러 설정
  static void _setupMessageHandlers() {
    // 포그라운드 메시지 핸들러
    FirebaseMessaging.onMessage.listen((RemoteMessage message) {
      debugPrint(' 포그라운드 메시지 수신: ${message.notification?.title}');
      // 로컬 알림 표시 (선택사항)
    });
    
    // 백그라운드 메시지 핸들러
    FirebaseMessaging.onMessageOpenedApp.listen((RemoteMessage message) {
      debugPrint(' 백그라운드 메시지 클릭: ${message.notification?.title}');
      // Deep Linking 처리
    });
  }
  
  /// FCM 토큰 가져오기
  static Future<String?> getToken() async {
    try {
      return await _fcm.getToken();
    } catch (e) {
      debugPrint(' FCM 토큰 가져오기 실패: $e');
      return null;
    }
  }
}
```

### 5.3 로그인 시 토큰 저장

로그인 성공 시 FCM 토큰을 자동으로 저장하도록 구현되어 있습니다.

---

## 6. 채널별 푸시 알림

### 6.1 채널 개념

FCM 채널은 사용자가 알림을 타입별로 구분하고 설정할 수 있게 해주는 기능입니다:

- **Android**: Notification Channel (`channel_id`)
- **iOS**: Notification Category (`category`)
- **Web**: Notification Tag (`tag`)

### 6.2 정적 채널 vs 동적 채널

#### 정적 채널 (Static Channel)
앱에서 미리 정의된 고정 채널입니다. 예:
- `general_channel` - 일반 알림
- `comment_channel` - 댓글 알림
- `like_channel` - 좋아요 알림
- `announcement_channel` - 공지사항 알림
- `follow_channel` - 팔로우 알림

#### 동적 채널 (Dynamic Channel)
런타임에 생성되는 채널입니다. 예:
- `chat_room_{roomId}` - 채팅방별 알림 (예: `chat_room_123`, `chat_room_456`)
- `group_{groupId}` - 그룹별 알림

### 6.3 Flutter에서 채널 생성

#### 파일: `lib/core/services/push_notification_service.dart` 업데이트

```dart
class PushNotificationService {
  // ... 기존 코드 ...

  /// 알림 채널 생성 (정적 채널)
  static Future<void> _createStaticChannels() async {
    if (!Platform.isAndroid) return;

    final androidPlugin = _localNotifications
        .resolvePlatformSpecificImplementation<
            AndroidFlutterLocalNotificationsPlugin>();

    if (androidPlugin == null) return;

    // 일반 채널
    const generalChannel = AndroidNotificationChannel(
      'general_channel',
      '일반 알림',
      description: '일반적인 알림을 위한 채널입니다.',
      importance: Importance.defaultImportance,
      playSound: true,
    );

    // 댓글 채널
    const commentChannel = AndroidNotificationChannel(
      'comment_channel',
      '댓글 알림',
      description: '댓글이 달렸을 때 알림을 받습니다.',
      importance: Importance.high,
      playSound: true,
    );

    // 좋아요 채널
    const likeChannel = AndroidNotificationChannel(
      'like_channel',
      '좋아요 알림',
      description: '좋아요를 받았을 때 알림을 받습니다.',
      importance: Importance.defaultImportance,
      playSound: true,
    );

    // 공지사항 채널
    const announcementChannel = AndroidNotificationChannel(
      'announcement_channel',
      '공지사항',
      description: '중요한 공지사항을 받습니다.',
      importance: Importance.max,
      playSound: true,
      enableVibration: true,
    );

    // 팔로우 채널
    const followChannel = AndroidNotificationChannel(
      'follow_channel',
      '팔로우 알림',
      description: '새로운 팔로워 알림을 받습니다.',
      importance: Importance.defaultImportance,
      playSound: true,
    );

    // 모든 정적 채널 생성
    await androidPlugin.createNotificationChannel(generalChannel);
    await androidPlugin.createNotificationChannel(commentChannel);
    await androidPlugin.createNotificationChannel(likeChannel);
    await androidPlugin.createNotificationChannel(announcementChannel);
    await androidPlugin.createNotificationChannel(followChannel);

    debugPrint(' 정적 알림 채널 생성 완료');
  }

  /// 동적 채널 생성 (예: 채팅방별)
  static Future<String> createChatRoomChannel(String roomId) async {
    if (!Platform.isAndroid) return 'chat_room_$roomId';

    final androidPlugin = _localNotifications
        .resolvePlatformSpecificImplementation<
            AndroidFlutterLocalNotificationsPlugin>();

    if (androidPlugin == null) return 'chat_room_$roomId';

    final channelId = 'chat_room_$roomId';
    
    const channel = AndroidNotificationChannel(
      channelId,
      '채팅 알림',
      description: '채팅방 메시지 알림을 받습니다.',
      importance: Importance.high,
      playSound: true,
      enableVibration: true,
      showBadge: true,
    );

    await androidPlugin.createNotificationChannel(channel);
    debugPrint(' 동적 채널 생성: $channelId');

    return channelId;
  }

  /// iOS Notification Category 설정
  static Future<void> _setupIOSCategories() async {
    if (!Platform.isIOS) return;

    // iOS는 UNNotificationCategory를 사용합니다
    // flutter_local_notifications 패키지가 자동으로 처리합니다
    // 필요시 추가 설정 가능
    debugPrint(' iOS 알림 카테고리 설정 완료');
  }

  /// 초기화 메서드 업데이트
  static Future<void> initialize() async {
    try {
      // 알림 권한 요청
      NotificationSettings settings = await _fcm.requestPermission(
        alert: true,
        announcement: false,
        badge: true,
        carPlay: false,
        criticalAlert: false,
        provisional: false,
        sound: true,
      );
      
      if (settings.authorizationStatus == AuthorizationStatus.authorized) {
        debugPrint(' 알림 권한 승인됨');
      } else {
        debugPrint(' 알림 권한 거부됨');
        return;
      }
      
      // 로컬 알림 초기화
      await _initializeLocalNotifications();
      
      // 정적 채널 생성
      await _createStaticChannels();
      
      // iOS 카테고리 설정
      await _setupIOSCategories();
      
      // FCM 토큰 가져오기 및 저장
      await _setupFCMToken();
      
      // 알림 핸들러 설정
      _setupMessageHandlers();
      
      debugPrint(' 푸시 알림 서비스 초기화 완료');
    } catch (e) {
      debugPrint(' 푸시 알림 초기화 실패: $e');
    }
  }
}
```

### 6.4 채널별 푸시 전송 예시

#### 예시 1: 공지사항 (정적 채널)

```typescript
// Edge Function 호출 시
const response = await fetch(`${SUPABASE_URL}/functions/v1/send-push-notification`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${SUPABASE_SERVICE_ROLE_KEY}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    userId: targetUserId,
    title: '새로운 공지사항',
    body: '중요한 공지사항이 있습니다.',
    channelId: 'announcement_channel', // 정적 채널 명시
    data: {
      type: 'announcement',
      announcementId: '123',
    },
  }),
});
```

#### 예시 2: 채팅방 (동적 채널)

```typescript
// 채팅방 ID로 동적 채널 생성
const roomId = 'room_123';
const channelId = `chat_room_${roomId}`;

const response = await fetch(`${SUPABASE_URL}/functions/v1/send-push-notification`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${SUPABASE_SERVICE_ROLE_KEY}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    userId: targetUserId,
    title: '새 메시지',
    body: `${senderName}: ${messageText}`,
    channelId: channelId, // 동적 채널 사용
    data: {
      type: 'chat',
      roomId: roomId,
      messageId: 'msg_456',
    },
  }),
});
```

#### 예시 3: 자동 채널 매핑 (data.type 기반)

```typescript
// channelId를 생략하면 data.type으로 자동 매핑
const response = await fetch(`${SUPABASE_URL}/functions/v1/send-push-notification`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${SUPABASE_SERVICE_ROLE_KEY}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    userId: targetUserId,
    title: '새로운 댓글',
    body: '댓글이 달렸습니다.',
    // channelId 생략 시 data.type이 'comment'이므로 자동으로 'comment_channel' 사용
    data: {
      type: 'comment',
      postId: 'post_789',
      commentId: 'comment_123',
    },
  }),
});
```

### 6.5 채널별 알림 설정 관리

사용자는 Android 설정에서 각 채널별로 알림을 개별적으로 끄고 켤 수 있습니다:

1. Android 설정 → 앱 → [앱 이름] → 알림
2. 각 채널별로 알림 끄기/켜기 가능
3. 소리, 진동, 배지 등 세부 설정 가능

이를 통해 사용자는:
- 공지사항은 받되, 좋아요 알림은 끌 수 있음
- 특정 채팅방 알림만 받고 싶을 수 있음
- 알림 타입별로 다른 소리/진동 설정 가능

---

## 7. Edge Function 구현

### 6.1 Supabase CLI 설치

```bash
npm install -g supabase
```

### 6.2 Edge Function 생성

```bash
supabase login
supabase functions new send-push-notification
```

### 7.1 Edge Function 코드 작성

`supabase/functions/send-push-notification/index.ts`:

이 Edge Function은 채널별 푸시 알림을 지원합니다.

**주요 기능:**
- `channelId` 파라미터로 채널 지정 가능
- `data.type` 기반 자동 채널 매핑
- 플랫폼별 채널 설정 (Android: `channel_id`, iOS: `category`, Web: `tag`)

**요청 파라미터:**
```typescript
{
  userId: string,           // 필수: 대상 사용자 ID
  title: string,            // 필수: 알림 제목
  body: string,             // 필수: 알림 본문
  channelId?: string,       // 선택: 채널 ID (명시적 지정)
  data?: {                  // 선택: 추가 데이터
    type?: string,          // 알림 타입 (comment, like, chat, announcement 등)
    [key: string]: any
  }
}
```

**채널 자동 매핑:**
- `data.type`이 `comment` → `comment_channel`
- `data.type`이 `like` → `like_channel`
- `data.type`이 `follow` → `follow_channel`
- `data.type`이 `message` → `message_channel`
- `data.type`이 `post` → `post_channel`
- 기본값: `general_channel`

**동적 채널 지원:**
- `chat_room_{roomId}` 형식의 동적 채널 지원
- 예: `channelId: 'chat_room_123'`

**전체 코드는 `functions/send-push-notification/index.ts` 파일 참조**

### 7.2 Edge Function 호출 예시

#### 예시 1: 공지사항 (정적 채널)

```dart
// Flutter에서 호출
final response = await SupabaseService.client.functions.invoke(
  'send-push-notification',
  body: {
    'userId': targetUserId,
    'title': '새로운 공지사항',
    'body': '중요한 공지사항이 있습니다.',
    'channelId': 'announcement_channel',
    'data': {
      'type': 'announcement',
      'announcementId': '123',
    },
  },
);
```

#### 예시 2: 채팅방 메시지 (동적 채널)

```dart
final roomId = 'room_123';
final response = await SupabaseService.client.functions.invoke(
  'send-push-notification',
  body: {
    'userId': targetUserId,
    'title': '새 메시지',
    'body': '$senderName: $messageText',
    'channelId': 'chat_room_$roomId', // 동적 채널
    'data': {
      'type': 'chat',
      'roomId': roomId,
      'messageId': 'msg_456',
    },
  },
);
```

#### 예시 3: 자동 채널 매핑 (data.type 기반)

```dart
// channelId를 생략하면 data.type으로 자동 매핑
final response = await SupabaseService.client.functions.invoke(
  'send-push-notification',
  body: {
    'userId': targetUserId,
    'title': '새로운 댓글',
    'body': '댓글이 달렸습니다.',
    // channelId 생략 → data.type='comment' → 'comment_channel' 자동 사용
    'data': {
      'type': 'comment',
      'postId': 'post_789',
      'commentId': 'comment_123',
    },
  },
);
```

### 7.3 환경 변수 설정

```bash
supabase secrets set FCM_SERVER_KEY='your_firebase_server_key'
supabase secrets set SUPABASE_URL='your_supabase_url'
supabase secrets set SUPABASE_SERVICE_ROLE_KEY='your_service_role_key'
```

### 7.4 Edge Function 배포

```bash
supabase functions deploy send-push-notification
```

---

## 8. 테스트 및 검증

### 8.1 FCM 토큰 확인

1. 앱 실행 및 로그인
2. 콘솔 로그에서 FCM 토큰 확인
3. Supabase 대시보드 → **Table Editor** → **device_tokens** 테이블 확인

### 8.2 Firebase Console에서 테스트

1. Firebase Console → **클라우드 메시징** 클릭
2. **"새 알림 보내기"** 클릭
3. 알림 제목과 텍스트 입력
4. **"테스트 메시지 전송"** 클릭
5. FCM 토큰 입력 후 **"테스트"** 클릭

### 8.3 채널별 푸시 테스트

#### 테스트 1: 정적 채널 테스트

```dart
// 공지사항 채널 테스트
await SupabaseService.client.functions.invoke(
  'send-push-notification',
  body: {
    'userId': testUserId,
    'title': '테스트 공지사항',
    'body': '이것은 공지사항 채널 테스트입니다.',
    'channelId': 'announcement_channel',
    'data': {'type': 'announcement'},
  },
);
```

**확인 사항:**
- Android: 설정 → 알림에서 `공지사항` 채널로 표시되는지 확인
- iOS: 알림이 올바른 카테고리로 분류되는지 확인

#### 테스트 2: 동적 채널 테스트 (채팅방)

```dart
// 채팅방별 채널 테스트
final roomId = 'test_room_123';
await PushNotificationService.createChatRoomChannel(roomId);

await SupabaseService.client.functions.invoke(
  'send-push-notification',
  body: {
    'userId': testUserId,
    'title': '테스트 채팅',
    'body': '채팅방 알림 테스트입니다.',
    'channelId': 'chat_room_$roomId',
    'data': {
      'type': 'chat',
      'roomId': roomId,
    },
  },
);
```

**확인 사항:**
- Android: 채팅방별로 별도 채널이 생성되는지 확인
- 사용자가 특정 채팅방 알림만 끌 수 있는지 확인

#### 테스트 3: 자동 채널 매핑 테스트

```dart
// data.type 기반 자동 매핑 테스트
await SupabaseService.client.functions.invoke(
  'send-push-notification',
  body: {
    'userId': testUserId,
    'title': '테스트 댓글',
    'body': '자동 채널 매핑 테스트입니다.',
    // channelId 생략
    'data': {
      'type': 'comment', // 자동으로 comment_channel 사용
      'postId': 'test_post',
    },
  },
);
```

**확인 사항:**
- `channelId`를 생략해도 `data.type`에 따라 올바른 채널이 사용되는지 확인

### 8.4 채널별 알림 설정 확인

**Android:**
1. 설정 → 앱 → [앱 이름] → 알림
2. 각 채널별로 알림이 개별적으로 관리되는지 확인
3. 채널별로 소리, 진동 설정이 다르게 적용되는지 확인

**iOS:**
1. 설정 → 알림 → [앱 이름]
2. 카테고리별로 알림 설정이 관리되는지 확인

---

## 9. 문제 해결

### 오류 1: "Firebase 초기화 실패"
**해결**: `google-services.json` (Android) 또는 `GoogleService-Info.plist` (iOS) 파일 확인

### 오류 2: "FCM 토큰을 가져올 수 없습니다"
**해결**: 알림 권한 확인 및 Firebase 설정 확인

### 오류 3: iOS에서 알림이 표시되지 않음
**해결**: APNs 인증 키 설정 및 Push Notifications capability 확인

### 오류 4: 채널이 작동하지 않음 (Android)
**원인**: 채널이 생성되지 않았거나, 잘못된 `channel_id` 사용

**해결:**
1. `_createStaticChannels()` 메서드가 호출되었는지 확인
2. Android 로그에서 채널 생성 메시지 확인
3. 올바른 `channelId`가 전달되는지 확인
4. Android 8.0 (API 26) 이상인지 확인

### 오류 5: 동적 채널이 생성되지 않음
**원인**: 채팅방 입장 시 채널 생성 메서드가 호출되지 않음

**해결:**
1. `createChatRoomChannel(roomId)` 메서드를 채팅방 입장 시 호출
2. 채널 ID 형식이 `chat_room_{roomId}`인지 확인
3. Edge Function에서 동일한 형식의 `channelId` 전달 확인

---

## 10. 다음 단계

푸시 알림 설정이 완료되면:

1.  [Storage 초기 설정 가이드](./Storage/초기_설정_가이드.md) - 이미지 업로드 설정
2.  [소셜 로그인 완전 가이드](./소셜_로그인_완전_가이드.md) - 사용자 인증 설정

---

## 11. 참고 자료

- [Firebase Cloud Messaging 공식 문서](https://firebase.google.com/docs/cloud-messaging)
- [Supabase Edge Functions](https://supabase.com/docs/guides/functions)
- [Android Notification Channels](https://developer.android.com/training/notify-user/channels)
- [iOS Notification Categories](https://developer.apple.com/documentation/usernotifications/unnotificationcategory)

---

## 12. 변경 이력

### v2.2.0 (2024-12-19)
- 채널별 푸시 알림 기능 추가
- 정적 채널 및 동적 채널 지원
- 공지사항, 채팅방 예시 추가
- 플랫폼별 채널 설정 가이드 추가

### v2.1.0 (2024-12-19)
- 최초 설계 문서 형태로 재구성
- Firebase → Supabase → Flutter 순서로 통합
- Edge Function 구현 포함

### v2.0.0 (2024-11-05)
- Firebase Cloud Messaging 연동

### v1.0.0 (2024-10-27)
- 초기 가이드 작성

